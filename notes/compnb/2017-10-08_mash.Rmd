---
title: "MASH analysis of first flowcell"
output:
  html_document:
    dev: CairoSVG
    fig.width: 7
    fig.height: 5
---

These are the results of a quick mash run over the first flowcell from the NovaSeq.

```{r setup,include=FALSE}
library(tidyverse)
library(pvclust)
```


```{r load-mash}
mash = as.matrix(read.delim("data/2017-10-08_mash/mash.dist", row.names = 1))
sampnames = sub(".fastq.gz", "", basename(rownames(mash)))
rownames(mash) = colnames(mash) = sampnames
```


```{r image-hclust,dev='png'}
image(mash)
```

```{r hclust-initial,fig.width=12,fig.height=8}
plot(hclust(as.dist(mash)), cex=0.2)
```

That's promising, as there are two major groups. The outliers are largely failed samples and blanks. Let's bring in the metadata and remove low-covered samples.

```{r metadata}
md = read.csv("data/common/nova-fc1-stats.csv", stringsAsFactors=F)

goodcov = md %>%
    filter(coverage >= 1.5)

m = match(as.character(goodcov$sample), sampnames)
mash.gc = mash[m, m]
```

Here, we plot the sum of the distances between a sample and all others against the sequencing yield of that sample. If there is a relationship between these, it would suggest that sequencing yield was a driving factor for Mash distances, which can happen (see the "All samples" plot).

```{r distsummary}
plot(goodcov$bases, colSums(mash.gc), main="Well-covered samples")
plot(md$bases, colSums(mash), main="All samples")
```

Now, let's cluster and plot the distance matrix ordered by the hclust dendrogram ordering.

```{r distmat,dev='png'}
hc = hclust(as.dist(mash.gc))
image(mash.gc[hc$order, hc$order], main="Mash distances", sub="Ordered by hclust order")
```

In the dendrogram below (esp. dendrogram), one can see several features indicating that the sequencing has worked very well. Firstly, replicates cluster very tightly. Secondly, there are two major groups (albens, sider of plates 3-6), and a section of smaller groups, corresponding to the 10 species on the first two plates. Thirdly, one can even see sites clustering to some extent; one can see several pairs of samples from the same site.

```{r tree,fig.width=12,fig.height=8}
plot(hc, cex=0.2)
```

And this is a histogram of pairwise mash distances. Only a few large ones, nice bimodal peak for within/between species. Interesting how similar intra- and inter- are here!

```{r distdensity}
plot(density(mash.gc[upper.tri(mash.gc)]), main="Density of Pairwise Distances")
```