configfile: "config.yml"
import snkmk
RUNLIB2SAMP, SAMP2RUNLIB = snkmk.make_runlib2samp()
SAMPLESETS = snkmk.make_samplesets(config['sample_sets'])
shell.prefix = "set -euo pipefail; "

#######################################################################
#                            Read-level QC                            #
#######################################################################


subworkflow reads:
    workdir: "."
    snakefile: "snakemake/reads.rules"

rule qc_runlib:
    input:
        [reads("data/reads/runs/{run}/{lib}.fastq.gz".format(run=run, lib=lib))
		for run, lib in RUNLIB2SAMP],

rule read_stats:
    input:
        reads("data/readstats/readnum_librun.tsv"),
        reads("data/readstats/readnum_samples.tsv"),

rule qc_samples:
    input:
        reads(expand("data/reads/samples/{sample}.fastq.gz", sample=SAMP2RUNLIB))


rule reads:
    input:
        rules.qc_runlib.input,
        rules.read_stats.input,
        rules.qc_samples.input,


#######################################################################
#                      De-novo Distance analysis                      #
#######################################################################

subworkflow denovo:
    workdir: "."
    snakefile: "snakemake/denovo.rules"

rule kwip:
    input:
        denovo(expand("data/kwip/k{ksize}-s{sketchsize}/{set}.dist",
                ksize=config["denovodist"]["ksize"],
                sketchsize=config["denovodist"]["kwip_sketchsize"],
                set=[s for s, v in SAMPLESETS.items() if len(v) >=3])),
rule mash:
    input:
        denovo(expand("data/mash/k{ksize}-s{sketchsize}/{set}.dist",
                ksize=config["denovodist"]["ksize"],
                sketchsize=config["denovodist"]["mash_sketchsize"],
                set=[s for s, v in SAMPLESETS.items() if len(v) >=3])),

rule denovo:
    input:
        rules.kwip.input,
        rules.mash.input,

#######################################################################
#                              All rule                               #
#######################################################################


rule all:
    input:
        rules.denovo.input,
        rules.reads.input,
